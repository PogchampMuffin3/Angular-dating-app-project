<!-- messages.html -->

<style>
  /* Wymuszenie szerokości sidebara */
  .chat-sidebar {
    width: 100%;
  }
  @media (min-width: 768px) {
    .chat-sidebar {
      width: 320px !important;
      min-width: 320px !important;
      border-left: 1px solid #dee2e6;
    }
    /* Na desktopie sidebar zawsze widoczny jako flex */
    .desktop-visible {
      display: flex !important;
    }
  }
</style>

<div class="messages-container d-flex h-100 w-100 position-relative">

  <!-- =========================================================================
       SEKCJA 1: CZAT (Lewa strona / Środek)
       ========================================================================= -->
  <section
    class="flex-column flex-grow-1 bg-white desktop-visible"
    [class.d-flex]="selectedUser"
    [class.d-none]="!selectedUser"
    style="min-width: 0;"
  >

    <!-- HEADER CZATU -->
    <div *ngIf="selectedUser" class="p-3 border-bottom d-flex align-items-center gap-3 bg-white" style="height: 72px;">
      <!-- Back button (tylko mobile) -->
      <button (click)="selectedUser = null" class="btn btn-link text-dark p-0 d-md-none me-2">
        <i class="bi bi-arrow-left fs-4"></i>
      </button>

      <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center fw-bold"
           style="width: 42px; height: 42px;">
        {{ selectedUser.name?.charAt(0) || 'U' }}
      </div>

      <div>
        <div class="fw-bold text-dark">{{ selectedUser.name }}</div>
        <div class="small text-success d-flex align-items-center gap-1">
          <span class="rounded-circle bg-success" style="width: 8px; height: 8px;"></span> Online
        </div>
      </div>
    </div>

    <!-- Empty State nagłówka (Tylko Desktop) -->
    <div *ngIf="!selectedUser" class="p-3 border-bottom d-none d-md-flex align-items-center bg-white" style="height: 72px;">
       <span class="fw-bold text-secondary">Select a chat</span>
    </div>

    <!-- OBSZAR WIADOMOŚCI -->
    <div class="flex-grow-1 overflow-auto p-4 d-flex flex-column" style="background-color: #f0f2f5;">

      <ng-container *ngIf="selectedUser; else noChatSelected">
        <div *ngFor="let msg of messages" class="d-flex mb-3"
             [ngClass]="{'justify-content-end': msg.fromId === myId, 'justify-content-start': msg.fromId !== myId}">
          <div class="p-3 shadow-sm text-break"
               [ngClass]="{
                 'bg-primary text-white': msg.fromId === myId,
                 'bg-white text-dark': msg.fromId !== myId
               }"
               style="max-width: 70%; border-radius: 12px; font-size: 0.95rem;">
            {{ msg.content }}
          </div>
        </div>
        <div *ngIf="messages?.length === 0" class="mt-auto text-center text-secondary">
          Start a new conversation.
        </div>
      </ng-container>

      <ng-template #noChatSelected>
        <div class="h-100 d-flex flex-column align-items-center justify-content-center text-muted">
          <i class="bi bi-chat-square-text display-4 mb-3" style="opacity: 0.2;"></i>
          <p>Select a conversation from the list to start chatting.</p>
        </div>
      </ng-template>
    </div>

    <!-- INPUT -->
    <div *ngIf="selectedUser" class="p-3 bg-white border-top">
      <div class="d-flex align-items-center gap-2 bg-white p-1 rounded-pill border">
        <input [(ngModel)]="newMessageText" (keyup.enter)="sendMessage()"
               type="text" class="form-control border-0 shadow-none bg-transparent ps-3"
               placeholder="Type a message..." />
        <button (click)="sendMessage()" class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center m-1"
                style="width: 38px; height: 38px;">
          <i class="bi bi-send-fill text-white small"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- =========================================================================
       SEKCJA 2: LISTA ROZMÓW (Prawa strona)
       ========================================================================= -->
  <aside
    class="chat-sidebar flex-column bg-white desktop-visible"
    [class.d-flex]="!selectedUser"
    [class.d-none]="selectedUser"
  >

    <!-- HEADER LISTY -->
    <div class="p-3 border-bottom" style="height: 72px; display: flex; align-items: center;">
      <div class="w-100 bg-light rounded-pill px-3 py-2 d-flex align-items-center">
        <i class="bi bi-search text-secondary me-2"></i>
        <input type="text" class="form-control border-0 bg-transparent p-0 shadow-none small"
               placeholder="Search..." />
      </div>
    </div>

    <!-- LISTA UŻYTKOWNIKÓW -->
    <div class="flex-grow-1 overflow-auto">
      <div *ngFor="let user of users" class="border-bottom">
        <button (click)="selectUser(user)"
                class="w-100 border-0 bg-transparent p-3 text-start d-flex align-items-center gap-3 list-group-item-action"
                [class.bg-light]="selectedUser?.id === user.id">

          <div class="position-relative">
            <div class="rounded-circle bg-light border d-flex align-items-center justify-content-center text-secondary fw-bold"
                 style="width: 48px; height: 48px;">
              {{ user.name?.charAt(0) || '?' }}
            </div>
            <span class="position-absolute bottom-0 end-0 bg-success border border-white rounded-circle p-1"
                  style="width: 12px; height: 12px;"></span>
          </div>

          <div class="overflow-hidden">
            <div class="fw-bold text-dark text-truncate">{{ user.name }}</div>
            <div class="small text-secondary text-truncate">
              {{ user.lastMsg || 'Brak wiadomości' }}
            </div>
          </div>
        </button>
      </div>

      <div *ngIf="!users || users.length === 0" class="p-4 text-center text-secondary small">
        No chats available.
      </div>
    </div>
  </aside>

</div>
